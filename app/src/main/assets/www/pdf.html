<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>pdf</title>
    <style>
        /* normalize.css */
        html { line-height: 1.15; -webkit-text-size-adjust: 100%; }
        body { margin: 0; }
        main { display: block; }
        h1 { font-size: 2em; margin: 0.67em 0; }
        hr { box-sizing: content-box; height: 0; overflow: visible; }
        pre { font-family: monospace, monospace; font-size: 1em; }
        a { background-color: transparent; }
        abbr[title] { border-bottom: none; text-decoration: underline; text-decoration: underline dotted; }
        b, strong { font-weight: bolder; }
        code, kbd, samp { font-family: monospace, monospace; font-size: 1em; }
        small { font-size: 80%; }
        sub, sup { font-size: 75%; line-height: 0; position: relative; vertical-align: baseline; }
        sub { bottom: -0.25em; }
        sup { top: -0.5em; }
        img { border-style: none; }
        button, input, optgroup, select, textarea { font-family: inherit; font-size: 100%; line-height: 1.15; margin: 0; }
        button, input { overflow: visible; }
        button, select { text-transform: none; }
        button, [type="button"], [type="reset"], [type="submit"] { -webkit-appearance: button; }
        button::-moz-focus-inner, [type="button"]::-moz-focus-inner, [type="reset"]::-moz-focus-inner, [type="submit"]::-moz-focus-inner { border-style: none; padding: 0; }
        button:-moz-focusring, [type="button"]:-moz-focusring, [type="reset"]:-moz-focusring, [type="submit"]:-moz-focusring { outline: 1px dotted ButtonText; }
        fieldset { padding: 0.35em 0.75em 0.625em; }
        legend { box-sizing: border-box; color: inherit; display: table; max-width: 100%; padding: 0; white-space: normal; }
        progress { vertical-align: baseline; }
        textarea { overflow: auto; }
        [type="checkbox"], [type="radio"] { box-sizing: border-box; padding: 0; }
        [type="number"]::-webkit-inner-spin-button, [type="number"]::-webkit-outer-spin-button { height: auto; }
        [type="search"] { -webkit-appearance: textfield; outline-offset: -2px; }
        [type="search"]::-webkit-search-decoration { -webkit-appearance: none; }
        ::-webkit-file-upload-button { -webkit-appearance: button; font: inherit; }
        details { display: block; }
        summary { display: list-item; }
        template { display: none; }
        [hidden] { display: none; }

        #pdf-container {
            margin-bottom: 40px;
        }
        .prev {
            position: fixed;
            left: 4%;
            bottom: 5px;
            top: 95%;
            width: 45%;
            height: 30px;
            z-index: 1000;
        }
        .next {
            position: fixed;
            right: 4%;
            bottom: 5px;
            top: 95%;
            width: 45%;
            height: 30px;
            z-index: 1000;
        }
    </style>
</head>
<body>
<div id="pdf-container">

</div>
<div>
    <button class="prev" id="prev">上一页</button>
    <button class="next" id="next">下一页</button>
</div>

<script src="pdf.js"></script>
<script>
window.onerror = function (message, source, lineno, colno, error) {
  console.log("Error: " + message + "\n" + "Source: " + source + "\n" + "Line: " + lineno + "\n" + "Column: " + colno + "\n" + "Stack: " + error.stack);
}
function getUrlParam(name) {
    var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
    var r = window.location.search.substring(1).match(reg);
    if (r != null) return unescape(r[2]); return null;
}
var base = window.location.protocol + "//" + window.location.host;
var file = base + "/" + getUrlParam("name");
var book_id = getUrlParam("book_id");
var cur = getUrlParam("cur");
var pages = getUrlParam("pages");
console.log('book_id:' + book_id + ', cur:' + cur + ', pages:' + pages);

var currentPage = 1;
if (cur != null && cur != '') {
    currentPage = parseInt(cur);
}
var container = document.getElementById('pdf-container');

//pdfjsLib.GlobalWorkerOptions.workerSrc = "pdf.worker.js"
pdfjsLib.getDocument({
    url: file,
    cMapUrl: 'https://cdn.jsdelivr.net/npm/pdfjs-dist@2.0.489/cmaps/',
    cMapPacked: true,
}).then((pdf) => {
    console.log('pdf ready');

    //console.log(pdf.numPages);
    var totalPage = pdf.numPages;

    // 获取目录
    pdf.getOutline().then(r => {
        console.log("outline:", r);
        //console.log('index:', pdf.getPageIndex(r[0]['dest'][0]))
    });

    function renderPage(pageNumber) {
      container.innerHTML = ''; // 清空容器
      pdf.getPage(pageNumber).then(function(page) {
        var scale = 1.5;
        var viewport = page.getViewport(scale);
        var canvas = document.createElement('canvas');
        var context = canvas.getContext('2d');
        canvas.width = viewport.width
        canvas.height = viewport.height;
        page.render({
          canvasContext: context,
          viewport: viewport
        });
        container.appendChild(canvas);
        currentPage = pageNumber;
        console.log('currentPage:' + currentPage + ', totalPage:' + totalPage);
        if (currentPage > 0 && totalPage > 0) {
            if (window.xbook) {
                window.xbook.report(book_id, currentPage, totalPage);
            }
        }
      });
    }
    renderPage(currentPage);

    document.getElementById('prev').addEventListener('click', (e) => {
        if (currentPage > 1) {
            renderPage(currentPage - 1);
        }
    });

    document.getElementById('next').addEventListener('click', (e) => {
        if (currentPage < pdf.numPages) {
            renderPage(currentPage + 1);
        }
    });

});

</script>
</body>
</html>