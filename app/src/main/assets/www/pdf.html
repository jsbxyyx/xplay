<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>pdf</title>
    <style>
        #pdf-container {
            margin-bottom: 40px;
        }
        .prev {
            position: fixed;
            left: 4%;
            bottom: 5px;
            top: 95%;
            width: 45%;
            height: 30px;
            z-index: 1000;
        }
        .next {
            position: fixed;
            right: 4%;
            bottom: 5px;
            top: 95%;
            width: 45%;
            height: 30px;
            z-index: 1000;
        }
    </style>
</head>
<body>
<div id="pdf-container">

</div>
<div>
    <button class="prev" id="prev">上一页</button>
    <button class="next" id="next">下一页</button>
</div>

<script src="pdf.js"></script>
<script>
function getUrlParam(name) {
    var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
    var r = window.location.search.substring(1).match(reg);
    if (r != null) return unescape(r[2]); return null;
}
var base = window.location.protocol + "//" + window.location.host;
var file = base + "/" + getUrlParam("name");
var book_id = getUrlParam("book_id");
var cur = getUrlParam("cur");
var pages = getUrlParam("pages");
console.log('book_id:' + book_id + ', cur:' + cur + ', pages:' + pages);

var currentPage = 1;
if (cur != null && cur != '') {
    currentPage = parseInt(cur);
}
var container = document.getElementById('pdf-container');

//pdfjsLib.GlobalWorkerOptions.workerSrc = "pdf.worker.js"
pdfjsLib.getDocument({
    url: file,
    cMapUrl: 'https://cdn.jsdelivr.net/npm/pdfjs-dist@2.0.489/cmaps/',
    cMapPacked: true,
}).then((pdf) => {
    console.log('pdf ready');

    //console.log(pdf.numPages);
    var totalPage = pdf.numPages;

    // 获取目录
    pdf.getOutline().then(r => {
        console.log("outline:", r);
        //console.log('index:', pdf.getPageIndex(r[0]['dest'][0]))
    });

    function renderPage(pageNumber) {
      container.innerHTML = ''; // 清空容器
      pdf.getPage(pageNumber).then(function(page) {
        var scale = 1.5;
        var viewport = page.getViewport(scale);
        var canvas = document.createElement('canvas');
        var context = canvas.getContext('2d');
        canvas.width = viewport.width
        canvas.height = viewport.height;
        page.render({
          canvasContext: context,
          viewport: viewport
        });
        container.appendChild(canvas);
        currentPage = pageNumber;
        console.log('currentPage:' + currentPage + ', totalPage:' + totalPage);
        if (currentPage > 0 && totalPage > 0) {
            if (window.xbook) {
                window.xbook.report(book_id, currentPage, totalPage);
            }
        }
      });
    }
    renderPage(currentPage);

    document.getElementById('prev').addEventListener('click', (e) => {
        if (currentPage > 1) {
            renderPage(currentPage - 1);
        }
    });

    document.getElementById('next').addEventListener('click', (e) => {
        if (currentPage < pdf.numPages) {
            renderPage(currentPage + 1);
        }
    });

});

</script>
</body>
</html>